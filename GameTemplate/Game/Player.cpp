#include "stdafx.h"
#include "Player.h"
#include "Game.h"
#include "GameCamera.h"
#include "Object.h"
Player::Player()
{
	
}


Player::~Player()
{
	
}

void Player::OnDestroy()
{
	DeleteGO(m_skinModelRender);
}

bool Player::Start()
{
	m_skinModelRender = NewGO<CSkinModelRender>(0);
	//cmoファイルの読み込み。
	m_skinModelRender->Init(L"Resource/modelData/sphere.cmo");
	m_skinModelRender->SetShadowCaster(true);
	m_skinModelRender->SetShadowReceiver(true);
	m_skinModelRender->SetScale(m_scale);
	m_characon.Init(
		m_radius,			//半径。 
		m_position			//初期位置。
	);
	return true;
}

void Player::Update()
{
	if (m_gamecamera == nullptr) {
		m_gamecamera = FindGO<GameCamera>();
	}
	Judgment();
	Move();
	//Turn();
	m_characon.SetPosition(m_position);
	m_skinModelRender->SetPosition(m_position + CVector3::AxisY() * m_radius);
	m_skinModelRender->SetRotation(m_rotation);
}

void Player::Judgment()
{
	const float SizeMultiply = 0.2f;

	QueryGOs<Object>(nullptr, [&](Object* object) {
		CVector3 pos = m_position + CVector3::AxisY() * m_radius - object->GetPosition();
		if (pos.LengthSq() <= (pow(m_radius + object->GetSize(), 2.0f) * 1.3f) && m_radius >= object->GetSize()) {
			float Radius = m_radius + (object->GetSize() / m_radius) * SizeMultiply * m_radius;
			float Quotient = Radius / m_radius;
			m_radius = Radius;
			m_characon.SetRadius(m_radius);
			m_scale = CVector3::One() + CVector3::One() * (m_radius / m_protradius - 1);
			m_skinModelRender->SetScale(m_scale);
			DeleteGO(object);
		}
		return true;
		});
}

/*void Player::AnimationController()
{
	//動いている速さが一定以上ならそれぞれのアニメーションを再生する
	const float RunSpeed = 9.0f * 9.0f;                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                                               0.0f * 300.0f;
	const float WalkSpeed = 2.0f * 2.0f;
	//アニメーションの補完時間
	const float ComplementTime = 0.2f;

	switch (m_state) {
	case enState_idle:
	case enState_walk:
		//走る
		if (m_movespeed.LengthSq() >= RunSpeed) {
			m_skinModelRender->PlayAnimation(enAnimationClip_run, ComplementTime);
			m_state = enState_walk;
		}
		//歩く
		else if (m_movespeed.LengthSq() >= WalkSpeed) {
			m_skinModelRender->PlayAnimation(enAnimationClip_walk, ComplementTime);
			m_state = enState_walk;
		}
		//待機
		else {
			m_skinModelRender->PlayAnimation(enAnimationClip_idle, ComplementTime);
			m_state = enState_idle;
		}
		Move();
		Turn();
		break;
	case enState_jump:
		m_skinModelRender->PlayAnimation(enAnimationClip_jump, ComplementTime);
		Move();
		Turn();
		break;
	}
}
*/
void Player::Move()
{
	//移動速度
	const float MoveSpeedMultiply = 550.0f;
	//重力
	const float GravityMoveSpeed = 900.0f;
	//ジャンプ速度
	const float JumpMoveSpeed = 700.0f;

	m_movespeed.x = 0.0f;
	m_movespeed.z = 0.0f;
	CVector3 stickL;
	stickL.x = GetPad(0).GetLStickXF();
	stickL.y = GetPad(0).GetLStickYF();
	stickL.z = 0.0f;
	CVector3 frontxz = MainCamera().GetFront();
	CVector3 rightxz = MainCamera().GetRight();
	frontxz *= stickL.y;
	rightxz *= stickL.x;
	m_movespeed += frontxz * MoveSpeedMultiply;
	m_movespeed += rightxz * MoveSpeedMultiply;
	m_movespeed.y -= GravityMoveSpeed * GameTime().GetFrameDeltaTime();
	m_position = m_characon.Execute(GameTime().GetFrameDeltaTime(), m_movespeed);
	if (m_characon.IsOnGround()) {
		m_movespeed.y = 0.0f;
		if (GetPad(0).IsTrigger(enButtonB)) {
			m_movespeed.y = JumpMoveSpeed;
		}
	}
}

void Player::Turn()
{
	const float RotationSpeed = 0.04f;

	CVector3 movespeedXZ = m_movespeed;
	movespeedXZ.y = 0.0f;
	if (movespeedXZ.LengthSq() <= 0.1f) {
		return;
	}
	float Lengh = movespeedXZ.Length();
	//ノーマライズして移動方向の方向ベクトルを求める
	movespeedXZ /= Lengh;
	CVector3 pos;
	//Y軸と方向ベクトルの外積ベクトルを求める
	pos.Cross(CVector3::AxisY(), movespeedXZ);
	CQuaternion rot;
	//外積ベクトルを元に回転させるクォータニオンを求める
	CVector3 Y = CVector3::AxisY();
	m_rotation.Multiply(pos);
	rot.SetRotationDeg(pos, Lengh * RotationSpeed);
	//求めたクォータニオンを乗算する
	m_rotation.Multiply(rot);
	//m_rotation.Multiply(rot,m_rotation);
}